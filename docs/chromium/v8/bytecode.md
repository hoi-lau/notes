---
title: 「v8」之字节码
date: 2022-04-28
categories:
 - chromium
tags:
 - v8
publish: false
---

使用v8提供的工具d8可以生成js文件对应的字节码.

js文件 bcode.js:

```JavaScript
function prtLog(i, j) {
  const cls = {
    p: {
      p: console.log
    }
  }
  return cls.p.p('', '', '', '')
}

prtLog(1, 2)
```

```sh
# 生成字节码
d8  --print-bytecode  bcode.js > bytecode.log
# 生成ast
d8  --print-ast  bcode.js > ast.log
```

v8生成的字节码:

```txt
[generated bytecode for function:  (0x080500253715 <SharedFunctionInfo>)]
Bytecode length: 28
Parameter count 1
Register count 4
Frame size 32
OSR urgency: 0
Bytecode age: 0
         0x805002537d8 @    0 : 13 00             LdaConstant [0]
         0x805002537da @    2 : c3                Star1 
         0x805002537db @    3 : 19 fe f8          Mov <closure>, r2
         0x805002537de @    6 : 65 57 01 f9 02    CallRuntime [DeclareGlobals], r1-r2
         0x805002537e3 @   11 : 21 01 00          LdaGlobal [1], [0]
         0x805002537e6 @   14 : c3                Star1 
         0x805002537e7 @   15 : 0d 01             LdaSmi [1]
         0x805002537e9 @   17 : c2                Star2 
         0x805002537ea @   18 : 0d 02             LdaSmi [2]
         0x805002537ec @   20 : c1                Star3 
         0x805002537ed @   21 : 63 f9 f8 f7 02    CallUndefinedReceiver2 r1, r2, r3, [2]
         0x805002537f2 @   26 : c4                Star0 
         0x805002537f3 @   27 : a9                Return 
Constant pool (size = 2)
0x805002537a5: [FixedArray] in OldSpace
 - map: 0x080500002239 <Map>
 - length: 2
           0: 0x08050025375d <FixedArray[2]>
           1: 0x0805002536d1 <String[6]: #prtLog>
Handler Table (size = 0)
Source Position Table (size = 0)
[generated bytecode for function: prtLog (0x08050025376d <SharedFunctionInfo prtLog>)]
Bytecode length: 59
Parameter count 3
Register count 7
Frame size 56
OSR urgency: 0
Bytecode age: 0
         0x80500253954 @    0 : 7c 00 00 08       CreateObjectLiteral [0], [0], #8
         0x80500253958 @    4 : c3                Star1 
         0x80500253959 @    5 : 7c 01 01 29       CreateObjectLiteral [1], [1], #41
         0x8050025395d @    9 : c2                Star2 
         0x8050025395e @   10 : 21 02 02          LdaGlobal [2], [2]
         0x80500253961 @   13 : c1                Star3 
         0x80500253962 @   14 : 2d f7 03 04       GetNamedProperty r3, [3], [4]
         0x80500253966 @   18 : 33 f8 04 06       DefineNamedOwnProperty r2, [4], [6]
         0x8050025396a @   22 : 0b f8             Ldar r2
         0x8050025396c @   24 : 33 f9 04 08       DefineNamedOwnProperty r1, [4], [8]
         0x80500253970 @   28 : 19 f9 fa          Mov r1, r0
         0x80500253973 @   31 : 2d fa 04 0a       GetNamedProperty r0, [4], [10]
         0x80500253977 @   35 : c2                Star2 
         0x80500253978 @   36 : 2d f8 04 0c       GetNamedProperty r2, [4], [12]
         0x8050025397c @   40 : c3                Star1 
         0x8050025397d @   41 : 13 05             LdaConstant [5]
         0x8050025397f @   43 : c1                Star3 
         0x80500253980 @   44 : 13 05             LdaConstant [5]
         0x80500253982 @   46 : c0                Star4 
         0x80500253983 @   47 : 13 05             LdaConstant [5]
         0x80500253985 @   49 : bf                Star5 
         0x80500253986 @   50 : 13 05             LdaConstant [5]
         0x80500253988 @   52 : be                Star6 
         0x80500253989 @   53 : 5c f9 f8 05 0e    CallProperty r1, r2-r6, [14]
         0x8050025398e @   58 : a9                Return 
Constant pool (size = 6)
0x80500253911: [FixedArray] in OldSpace
 - map: 0x080500002239 <Map>
 - length: 6
           0: 0x0805002538e9 <ObjectBoilerplateDescription[3]>
           1: 0x0805002538fd <ObjectBoilerplateDescription[3]>
           2: 0x0805000045c1 <String[7]: #console>
           3: 0x0805001c27a9 <String[3]: #log>
           4: 0x0805002538b5 <String[1]: #p>
           5: 0x080500002531 <String[0]: #>
Handler Table (size = 0)
Source Position Table (size = 0)
```

完整指令集定义:

src/interpreter/bytecodes.h

| 指令  | 含义 |
| ---- | ---- |
|  Ldar | 加载数据到累加器 |
| LdaSmi [1] | 将1加载到累加器 |
|  Star r1 | 累加器中的值写入到r1寄存器 |
| Add r0 | 将累加器中的值与寄存器r0中的值进行加法运算,存到累加器中 |
| Sub r2 | 累加器中的值减去寄存器r2中的值,存到累加器中 |
| CallProperty0 r0, r1 | 类似于 r0.r1(),存到累加器中 |
| CallProperty1 r0, r1, r2 | 类似于 r0.r1(r2),存到累加器中 |
| LdaConstant [0] | 加载常量池中索引为0的值到累加器 |
| LdaNamedProperty r1, [1], [2] | 获取r1寄存器的属性值为常数池索引为1的值, 2代表函数的所谓反馈向量的索引。 反馈向量包含用于性能优化的运行时信息。 |
| return | 返回累加器的值 |
| LdaUndefined | 同理, 加载undefined到累加器 |
| CreateObjectLiteral [0], [0], #8 | 创建对象,存到累加器中 |
